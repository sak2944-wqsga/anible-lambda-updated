import boto3
import time

def lambda_handler(event, context):
    ec2_instance_id = "i-047ff0b33d4346e87"

    ssm = boto3.client('ssm')

    # Step 1: Send command
    response = ssm.send_command(
        InstanceIds=[ec2_instance_id],
        DocumentName="AWS-RunShellScript",
        Parameters={
            'commands': [
                'ansible-playbook /etc/ansible/deploy.yaml'
            ]
        },
        CloudWatchOutputConfig={
            'CloudWatchOutputEnabled': True
        },
        TimeoutSeconds=600
    )

    command_id = response['Command']['CommandId']

    # IMPORTANT: Wait for SSM to start the command
    time.sleep(3)

    # Step 2: Poll status until complete
    for _ in range(60):  # poll for up to 120 seconds
        try:
            output = ssm.get_command_invocation(
                CommandId=command_id,
                InstanceId=ec2_instance_id
            )
        except ssm.exceptions.InvocationDoesNotExist:
            time.sleep(2)
            continue

        if output['Status'] in ['Success', 'Failed', 'Cancelled', 'TimedOut']:
            return {
                "status": output['Status'],
                "stdout": output.get('StandardOutputContent', ''),
                "stderr": output.get('StandardErrorContent', '')
            }

        time.sleep(2)

    return {
        "status": "Timeout",
        "stdout": "",
        "stderr": "Command did not finish in expected time"
    }
